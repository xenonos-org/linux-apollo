From 710e1723a9f57435f59578f3c76e88063cd09002 Mon Sep 17 00:00:00 2001
From: Ariadne Conill <ariadne@ariadne.space>
Date: Wed, 10 Jul 2024 14:53:05 -0700
Subject: [PATCH 10/29] elf: only enable PaX features by default if softmode is
 disabled

Signed-off-by: Ariadne Conill <ariadne@ariadne.space>
---
 fs/binfmt_elf.c | 8 +++++---
 1 file changed, 5 insertions(+), 3 deletions(-)

diff --git a/fs/binfmt_elf.c b/fs/binfmt_elf.c
index f48c1c5166fc..b0d1398049fd 100644
--- a/fs/binfmt_elf.c
+++ b/fs/binfmt_elf.c
@@ -860,9 +860,11 @@ static int openpax_set_flags(struct file * const file)
 #endif
 	current->mm->pax_flags = 0;
 
-	set_bit(PAXF_PAGEEXEC, &current->mm->pax_flags);
-	set_bit(PAXF_MPROTECT, &current->mm->pax_flags);
-	set_bit(PAXF_RANDMMAP, &current->mm->pax_flags);
+	if (!pax_softmode) {
+		set_bit(PAXF_PAGEEXEC, &current->mm->pax_flags);
+		set_bit(PAXF_MPROTECT, &current->mm->pax_flags);
+		set_bit(PAXF_RANDMMAP, &current->mm->pax_flags);
+	}
 
 #ifdef CONFIG_OPENPAX_XATTR_PAX_FLAGS
 	error = openpax_parse_xattr_flags(file);
-- 
2.51.2

