From f4e7a36323d64aec252b29cd899303e493776611 Mon Sep 17 00:00:00 2001
From: Ariadne Conill <ariadne@ariadne.space>
Date: Wed, 10 Jul 2024 17:40:01 -0700
Subject: [PATCH 12/29] elf: use PAXF_RANDMMAP to control whether ASLR is
 enabled on a process

Signed-off-by: Ariadne Conill <ariadne@ariadne.space>
---
 fs/binfmt_elf.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/fs/binfmt_elf.c b/fs/binfmt_elf.c
index 669f09f05d18..080227bd718f 100644
--- a/fs/binfmt_elf.c
+++ b/fs/binfmt_elf.c
@@ -1078,7 +1078,7 @@ static int load_elf_binary(struct linux_binprm *bprm)
 	}
 
 	const int snapshot_randomize_va_space = READ_ONCE(randomize_va_space);
-	if (!(current->personality & ADDR_NO_RANDOMIZE) && snapshot_randomize_va_space)
+	if (!(current->personality & ADDR_NO_RANDOMIZE) && test_bit(PAXF_RANDMMAP, &current->mm->pax_flags))
 		current->flags |= PF_RANDOMIZE;
 
 	setup_new_exec(bprm);
-- 
2.51.2

