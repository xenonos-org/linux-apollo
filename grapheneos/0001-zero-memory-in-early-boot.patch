From 49c33279b9f74a693d2a6518d4f84f438ac81c74 Mon Sep 17 00:00:00 2001
From: Daniel Micay <daniel.micay@grapheneos.org>
Date: Thu, 6 Feb 2025 07:32:14 -0500
Subject: [PATCH] zero memory in early boot

---
 arch/arm/mm/init.c       |  2 ++
 arch/arm64/mm/init.c     |  1 +
 arch/x86/mm/init.c       |  1 +
 include/linux/memblock.h |  1 +
 mm/Makefile              |  2 +-
 mm/memzero.c             | 23 +++++++++++++++++++++++
 6 files changed, 29 insertions(+), 1 deletion(-)
 create mode 100644 mm/memzero.c

diff --git a/arch/arm/mm/init.c b/arch/arm/mm/init.c
index a42e4cd11db2..eec711cdd408 100644
--- a/arch/arm/mm/init.c
+++ b/arch/arm/mm/init.c
@@ -208,6 +208,8 @@ void __init bootmem_init(void)
 
 	find_limits(&min_low_pfn, &max_low_pfn, &max_pfn);
 
+	early_memzero((phys_addr_t)min_low_pfn << PAGE_SHIFT,
+		      (phys_addr_t)max_low_pfn << PAGE_SHIFT);
 	early_memtest((phys_addr_t)min_low_pfn << PAGE_SHIFT,
 		      (phys_addr_t)max_low_pfn << PAGE_SHIFT);
 
diff --git a/arch/arm64/mm/init.c b/arch/arm64/mm/init.c
index 7c85aa9aeeb3..8dc84c1b26b3 100644
--- a/arch/arm64/mm/init.c
+++ b/arch/arm64/mm/init.c
@@ -466,6 +466,7 @@ void __init bootmem_init(void)
 	min = PFN_UP(memblock_start_of_DRAM());
 	max = PFN_DOWN(memblock_end_of_DRAM());
 
+	early_memzero(min << PAGE_SHIFT, max << PAGE_SHIFT);
 	early_memtest(min << PAGE_SHIFT, max << PAGE_SHIFT);
 
 	max_pfn = max_low_pfn = max;
diff --git a/arch/x86/mm/init.c b/arch/x86/mm/init.c
index 0e4434373f6d..ea054ee8a15a 100644
--- a/arch/x86/mm/init.c
+++ b/arch/x86/mm/init.c
@@ -817,6 +817,7 @@ void __init init_mem_mapping(void)
 
 	x86_init.hyper.init_mem_mapping();
 
+	early_memzero(0, max_pfn_mapped << PAGE_SHIFT);
 	early_memtest(0, max_pfn_mapped << PAGE_SHIFT);
 }
 
diff --git a/include/linux/memblock.h b/include/linux/memblock.h
index 0d999b355557..d84c4d279daf 100644
--- a/include/linux/memblock.h
+++ b/include/linux/memblock.h
@@ -604,6 +604,7 @@ static inline void early_memtest(phys_addr_t start, phys_addr_t end) { }
 static inline void memtest_report_meminfo(struct seq_file *m) { }
 #endif
 
+extern void early_memzero(phys_addr_t start, phys_addr_t end);
 
 extern void __init_memblock memblock_memsize_record(const char *name,
 		phys_addr_t base, phys_addr_t size, bool nomap, bool reusable);
diff --git a/mm/Makefile b/mm/Makefile
index 29037c2c8c99..ac8119ff4924 100644
--- a/mm/Makefile
+++ b/mm/Makefile
@@ -50,7 +50,7 @@ ifdef CONFIG_64BIT
 mmu-$(CONFIG_MMU)	+= mseal.o
 endif
 
-obj-y			:= filemap.o mempool.o oom_kill.o fadvise.o \
+obj-y			:= memzero.o filemap.o mempool.o oom_kill.o fadvise.o \
 			   maccess.o page-writeback.o folio-compat.o \
 			   readahead.o swap.o truncate.o vmscan.o shmem.o \
 			   util.o mmzone.o vmstat.o backing-dev.o \
diff --git a/mm/memzero.c b/mm/memzero.c
new file mode 100644
index 000000000000..c7a88ee89b81
--- /dev/null
+++ b/mm/memzero.c
@@ -0,0 +1,23 @@
+// SPDX-License-Identifier: GPL-2.0
+#include <linux/kernel.h>
+#include <linux/types.h>
+#include <linux/init.h>
+#include <linux/memblock.h>
+#include <linux/string.h>
+
+void __init early_memzero(phys_addr_t start, phys_addr_t end)
+{
+	u64 i;
+	phys_addr_t this_start, this_end;
+
+	pr_info("Early memory zeroing");
+	for_each_free_mem_range(i, NUMA_NO_NODE, MEMBLOCK_NONE, &this_start,
+				&this_end, NULL) {
+		this_start = clamp(this_start, start, end);
+		this_end = clamp(this_end, start, end);
+		if (this_start < this_end) {
+			pr_info("  zero %pa - %pa\n", &this_start, &this_end);
+			memzero_explicit(__va(this_start), this_end - this_start);
+		}
+	}
+}
